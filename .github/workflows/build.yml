name: Build

on:
  schedule:
    - cron: '0 3 * * *'
  push:
    branches: [ 'master' ]
    paths-ignore: # 使用 ignore 更简洁，忽略文档变动触发构建
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
  workflow_call:

# 定义全局变量，方便统一修改版本名称格式
env:
  APP_NAME: KMP-MineStableDiffusion

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # 修正版本
        with:
          submodules: 'recursive'

      # 缓存 Submodules，加速大型 C++ 库拉取
      - name: Cache Submodules
        uses: actions/cache@v4
        with:
          path: .git/modules
          key: ${{ runner.os }}-submodules-${{ hashFiles('.gitmodules') }}

      - uses: actions/setup-java@v4 # 修正版本
        with:
          distribution: 'zulu'
          java-version: 21

      - uses: gradle/actions/setup-gradle@v4

      - name: Run tests
        run: ./gradlew jvmTest

  build-desktop:
    needs: test # 只有测试通过才进行耗时的构建
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macos-aarch64
            runner: macos-latest
            task: ./gradlew packageReleaseDmg
            output_dir: composeApp/build/compose/binaries/main-release/dmg
            ext: dmg

          - name: macos-x86_64
            runner: macos-13 # 指定 Intel Mac (macos-latest 目前主要是 arm64)
            task: ./gradlew packageReleaseDmg
            output_dir: composeApp/build/compose/binaries/main-release/dmg
            ext: dmg

          - name: linux-x86_64
            runner: ubuntu-latest
            # 移除 createReleaseDistributable，因为通常只需要安装包
            task: ./gradlew packageReleaseDeb packageReleaseRpm
            output_dir: composeApp/build/compose/binaries/main-release
            ext: deb

          - name: windows-x86_64
            runner: windows-latest
            task: ./gradlew.bat packageReleaseMsi packageReleaseExe
            output_dir: composeApp/build/compose/binaries/main-release
            ext: exe

    runs-on: ${{ matrix.runner }}
    name: Build ${{ matrix.name }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # 针对 Windows 的关键修复：安装 Android SDK 防止配置阶段报错
      - name: Setup Android SDK (Windows Fix)
        if: startsWith(matrix.runner, 'windows')
        uses: android-actions/setup-android@v3

      # 针对 macOS 的建议：如果 C++ 构建需要 Vulkan SDK，这里可能需要补充安装步骤
      # 目前暂保持原样，如果报错请添加 install-vulkan 步骤

      - uses: actions/setup-java@v4
        with:
          distribution: 'jetbrains' # Jetbrains JDK 对 Compose 支持更好
          java-version: 21

      - uses: gradle/actions/setup-gradle@v4

      - name: Build
        run: ${{ matrix.task }}

      # ==== 优化点：构建后立即重命名，不需要单独的 Package Job ====
      - name: Rename and Prepare Artifacts
        shell: bash
        run: |
          # 定义版本号，优先使用 Tag，没有 Tag 使用 commit hash
          VERSION="${{ github.ref_name }}"
          if [[ "$VERSION" == "master" ]]; then
            VERSION="nightly-${{ github.sha }}"
          fi
          
          echo "Processing artifacts for ${{ matrix.name }} version $VERSION"
          
          # 创建统一的上传目录
          mkdir -p upload_dist
          
          # 查找并移动/重命名文件
          find ${{ matrix.output_dir }} -type f \( -name "*.dmg" -o -name "*.msi" -o -name "*.exe" -o -name "*.deb" -o -name "*.rpm" \) | while read FILE; do
            EXTENSION="${FILE##*.}"
            NEW_NAME="${{ env.APP_NAME }}-${{ matrix.name }}-${VERSION}.${EXTENSION}"
            echo "Renaming $FILE -> upload_dist/$NEW_NAME"
            mv "$FILE" "upload_dist/$NEW_NAME"
          done

          # Windows 特殊处理：制作 Portable Zip
          if [[ "${{ matrix.runner }}" == "windows"* ]]; then
             if [ -d "composeApp/build/compose/binaries/main-release/app" ]; then
                echo "Zipping Portable version..."
                7z a "upload_dist/${{ env.APP_NAME }}-${{ matrix.name }}-${VERSION}-portable.zip" ./composeApp/build/compose/binaries/main-release/app/*
             fi
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-artifacts
          path: upload_dist/*

  # AppImage 构建通常比较特殊，保留单独 Job，但解耦了对 Mac 的依赖
  package-appimage:
    needs: build-desktop
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            appimagetool: appimagetool-x86_64.AppImage
          # - arch: aarch64 ... (注释掉直到你需要)
    runs-on: ${{ matrix.runner }}
    name: Build AppImage ${{ matrix.arch }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # 只下载 Linux 的 Deb/Rpm 产物用于提取，不需要下载 Mac 的
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-${{ matrix.arch }}-artifacts
          path: downloaded_artifacts

      - name: Build AppImage
        run: |
          # 提取版本号
          VERSION="${{ github.ref_name }}"
          if [[ "$VERSION" == "master" ]]; then VERSION="nightly"; fi

          # 下载工具
          wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/${{ matrix.appimagetool }}
          chmod +x ${{ matrix.appimagetool }}

          # 准备 AppDir (这里建议优化：直接从 Gradle 的 app 目录解压，或者解压 deb 包)
          # 由于之前的 job 没有上传 app 文件夹，这里我们解压 deb 包来获取文件
          mkdir -p AppDir
          DEB_FILE=$(find downloaded_artifacts -name "*.deb" | head -n 1)
          ar x "$DEB_FILE" data.tar.xz
          tar -xf data.tar.xz -C AppDir
          
          # 注意：解压 Deb 后的路径通常是 AppDir/opt/package-name/... 需要根据实际情况调整
          # 假设你的 Deb 安装路径是 /opt/MineStableDiffusion
          # 下面的路径可能需要根据你 Gradle 的 packager 配置进行微调
          
          # 简化演示，重新组织文件结构 (请根据实际 Deb 结构调整)
          mkdir -p AppDir/usr/bin
          # 寻找主程序
          BINARY_PATH=$(find AppDir -name "MineStableDiffusion" -type f | head -n 1)
          BINARY_DIR=$(dirname "$BINARY_PATH")
          cp -r "$BINARY_DIR"/* AppDir/usr/bin/

          # 创建 Desktop file 和 AppRun (保持你原有的逻辑，稍作精简)
          cat > AppDir/MineStableDiffusion.desktop << 'EOF'
          [Desktop Entry]
          Name=MineStableDiffusion
          Exec=MineStableDiffusion
          Icon=MineStableDiffusion
          Type=Application
          Categories=Utility;
          EOF
          
          cp AppDir/MineStableDiffusion.desktop AppDir/usr/bin/ || true

          # 下载 AppRun (推荐使用官方 AppRun 而不是手写脚本，兼容性更好)
          wget -q https://github.com/AppImage/AppImageKit/releases/download/13/AppRun-x86_64 -O AppDir/AppRun
          chmod +x AppDir/AppRun

          # 图标
          if [ -f "docs/AppIcon.png" ]; then
            cp docs/AppIcon.png AppDir/MineStableDiffusion.png
            cp docs/AppIcon.png AppDir/.DirIcon
          fi

          # 生成
          # 解决 FUSE 问题
          export APPIMAGE_EXTRACT_AND_RUN=1 
          ARCH=${{ matrix.arch }} ./${{ matrix.appimagetool }} AppDir ${{ env.APP_NAME }}-linux-${{ matrix.arch }}.AppImage

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}-appimage
          path: '*.AppImage'

  build-mobile:
    needs: test
    runs-on: ubuntu-latest # Android 构建用 Ubuntu 更快更便宜，除非你需要 iOS
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21

      - uses: gradle/actions/setup-gradle@v4

      # Android 构建也需要 Key，保持你原有的逻辑
      - name: Decode Keystore
        if: ${{ matrix.name != 'ios' }} # 简单防错
        env:
          RELEASE_KEY: ${{ secrets.RELEASE_KEY }}
        run: |
          if [ -n "$RELEASE_KEY" ]; then
            echo "$RELEASE_KEY" | base64 --decode > composeApp/release-key.jks
          fi

      - name: Build Android
        env:
          RELEASE_KEY_STORE_PASSWORD: ${{ secrets.RELEASE_KEY_STORE_PASSWORD }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: ./gradlew assembleRelease

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: composeApp/build/outputs/apk/release/*.apk